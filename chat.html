<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Chat (Trystero √ó Firebase RTDB)</title>
  <style>
    /* ---- Kakao-Ïä§ÌÉÄÏùº UI ---- */
    :root{
      --chat-yellow:#ffd84d;
      --chat-bg:#f7f6f2;
      --bubble-me:#2f2f33;
      --bubble-other:#ffffff;
      --muted:#757575;
      --radius:18px;
      --radius-xl:22px;
      --maxw:860px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--chat-bg);
      font-family:'Noto Sans KR','Malgun Gothic','Apple SD Gothic Neo',Pretendard,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }
    .app{min-height:100dvh;display:flex;flex-direction:column;}
    header{position:sticky;top:0;z-index:10;background:var(--chat-yellow);color:#111;padding:10px 14px;border-bottom:1px solid #e5c53a;}
    .bar{margin:0 auto;max-width:var(--maxw);display:flex;align-items:center;gap:10px}
    .bar h1{font-size:18px;margin:0;font-weight:800}
    .room-pill{margin-left:auto;background:#111;color:#fff;padding:4px 10px;border-radius:999px;font-size:12px;}
    .presence{font-size:12px;color:#111;opacity:.85}

    main{flex:1;overflow:auto;scroll-behavior:smooth;}
    .pad{max-width:var(--maxw);margin:0 auto;padding:14px;}
    .sys{display:flex;justify-content:center;margin:12px 0}
    .sys span{font-size:12px;color:#666;background:#eee;padding:4px 8px;border-radius:999px}

    .msg{display:flex;gap:8px;margin:6px 0;align-items:flex-end}
    .msg .avatar{width:28px;height:28px;border-radius:50%;flex:0 0 28px;background:#ddd;display:flex;align-items:center;justify-content:center;font-size:12px;color:#444}
    .bubble{
      max-width:70%;padding:10px 12px;border-radius:var(--radius);position:relative;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
      word-break:keep-all;overflow-wrap:anywhere;white-space:pre-wrap;line-height:1.45;font-size:15px;
    }
    .from-other .bubble{background:var(--bubble-other);border-top-left-radius:6px;border-top-right-radius:var(--radius-xl)}
    .from-me{justify-content:flex-end}
    .from-me .bubble{background:var(--bubble-me);color:#fff;border-top-right-radius:6px;border-top-left-radius:var(--radius-xl)}
    .name{font-size:12px;color:var(--muted);margin:0 0 4px 2px}
    .meta{display:flex;gap:6px;align-items:center;margin-top:6px}
    .time{font-size:11px;color:var(--muted)}

    .bubble a{color:inherit;text-decoration:underline;overflow-wrap:anywhere}
    .bubble img{max-width:360px;width:100%;height:auto;border-radius:12px;display:block;margin-top:6px}

    form.send{position:sticky;bottom:0;background:#fff;border-top:1px solid #e8e4d8;}
    .send .row{max-width:var(--maxw);margin:0 auto;padding:10px;display:flex;gap:8px;align-items:center}
    input[type=text]{flex:1;padding:12px 14px;border:1px solid #ddd;border-radius:14px;font-size:15px;}
    button{border:0;border-radius:14px;padding:10px 14px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #ccc}
    .attach-btn{min-width:40px}

    .setup{background:#fff;border-bottom:1px solid #eee}
    .setup .row{max-width:var(--maxw);margin:0 auto;padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
    .setup input{padding:10px 12px;border:1px solid #ddd;border-radius:12px}
    .setup label{font-size:12px;color:#444}

    @media (max-width:640px){
      .bubble{max-width:80%}
      .bar h1{font-size:16px}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <h1>Ïò§Ìîà P2P Ï±ÑÌåÖ</h1>
      <div class="presence" id="presence">‚Äî</div>
      <div class="room-pill" id="room-pill">room: ‚Äî</div>
    </div>
  </header>

  <section class="setup" id="setup">
    <div class="row">
      <label>ÎãâÎÑ§ÏûÑ <input id="nick" placeholder="Ïòà: ÎÇòÌõà" /></label>
      <label>Î£∏ ID <input id="roomId" placeholder="Ïòà: team-chat" /></label>
      <button id="start">ÏûÖÏû•</button>
      <button class="secondary" id="copy">Ï¥àÎåÄÎßÅÌÅ¨ Î≥µÏÇ¨</button>
    </div>
  </section>

  <main><div class="pad" id="messages"></div></main>

  <form class="send" id="sendForm">
    <div class="row">
      <button type="button" id="attach" class="secondary attach-btn" title="ÌååÏùº/Ïù¥ÎØ∏ÏßÄ Ï≤®Î∂Ä">üìé</button>
      <input type="file" id="file" multiple hidden>
      <input type="text" id="input" autocomplete="off" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî‚Ä¶ (URL ÏûêÎèô ÎßÅÌÅ¨, Ïù¥ÎØ∏ÏßÄ Î∂ôÏó¨ÎÑ£Í∏∞/ÎìúÎûòÍ∑∏ ÏßÄÏõê)" />
      <button type="submit">Î≥¥ÎÇ¥Í∏∞</button>
    </div>
  </form>
</div>

<!-- ======================= P2P Î°úÏßÅ ======================= -->
<script type="module">
  /* 1) Firebase & Trystero Î°úÎìú */
  import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getDatabase }    from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
  import { joinRoom, selfId } from "https://esm.run/trystero/firebase@0.20.1";

  /* 2) Firebase Ï¥àÍ∏∞Ìôî */
	const firebaseConfig = {
	  apiKey: "AIzaSyAhGKrEYZ-da_Qi0cKywn-WKH2rY0UDXtY",
	  authDomain: "neoprizm-chat-2025.firebaseapp.com",
	  databaseURL: "https://neoprizm-chat-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
	  projectId: "neoprizm-chat-2025",
	  storageBucket: "neoprizm-chat-2025.firebasestorage.app",
	  messagingSenderId: "565815382041",
	  appId: "1:565815382041:web:41e9921711ae51c5b1da88"
	};
  const firebaseApp = initializeApp(firebaseConfig);
  getDatabase(firebaseApp);        // RTDB Ïù∏Ïä§ÌÑ¥Ïä§ Ï§ÄÎπÑ

  /* ===== Ïú†Ìã∏ ===== */
  const $ = (sel)=>document.querySelector(sel);
  const formatTime = (ts)=>{ const d=new Date(ts); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
  const randomId = (len=6)=>Math.random().toString(36).slice(2,2+len);
  const toKB = (b)=>Math.round(b/1024);
  function linkifyToNodes(text){
    const urlRe = /(https?:\/\/[^\s]+)/g;
    const parts = String(text||'').split(urlRe);
    const frag = document.createDocumentFragment();
    for(const part of parts){
      if(/^https?:\/\//.test(part)){
        const a = document.createElement('a'); a.href=part; a.textContent=part; a.target='_blank'; a.rel='noopener noreferrer';
        frag.appendChild(a);
      }else frag.appendChild(document.createTextNode(part));
    }
    return frag;
  }
  /* Base64 Î≥ÄÌôò (Ï≤≠ÌÅ¨Ïö©) */
  function bytesToB64(bytes){ let s=''; for(let i=0;i<bytes.length;i+=0x8000){ s += String.fromCharCode.apply(null, bytes.subarray(i,i+0x8000)); } return btoa(s); }
  function b64ToBytes(b64){ const bin=atob(b64); const len=bin.length; const out=new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bin.charCodeAt(i); return out; }

  /* ===== ÏÉÅÌÉú ===== */
  let room, sendMsg, getMsg, sendName, getName, sendFile, getFile;
  let myName = localStorage.getItem('p2p_nick') || '';
  let myRoom = new URL(location.href).searchParams.get('room') || location.hash.slice(1) || '';
  let peers = new Set();
  const names = {};           // peerId ‚Üí name

  /* ÌÖçÏä§Ìä∏ ÌûàÏä§ÌÜ†Î¶¨(Î∞©Î≥Ñ) */
  const HIST_LIMIT = 500;
  const histKey = ()=> myRoom ? `p2p_chat_hist::${myRoom}` : '';
  const loadHist = ()=>{ try{ return JSON.parse(localStorage.getItem(histKey())||'[]'); }catch(e){ return []; } };
  const saveHist = (arr)=>{ try{ localStorage.setItem(histKey(), JSON.stringify(arr.slice(-HIST_LIMIT))); }catch(e){} };
  const pushHist = (msg)=>{ if(!histKey()) return; const arr=loadHist(); arr.push({name:msg.name,text:msg.text,ts:msg.ts,fromId:msg.fromId||null,mine:!!msg.mine}); saveHist(arr); };
  const renderHist = ()=> loadHist().forEach(m=>addMessage(m));

  /* Ï¥àÍ∏∞ Í∞í */
  $('#nick').value = myName;
  $('#roomId').value = myRoom || randomId();

  /* ===== UI Î†åÎçî ===== */
  function systemLine(text){ const wrap=document.createElement('div'); wrap.className='sys'; const s=document.createElement('span'); s.textContent=text; wrap.appendChild(s); $('#messages').appendChild(wrap); $('#messages').lastElementChild?.scrollIntoView({block:'end'}); }
  const renderPresence = ()=> $('#presence').textContent = `Ï†ëÏÜç ${peers.size+1}Î™Ö`;
  const renderRoomPill = ()=> $('#room-pill').textContent = `room: ${myRoom}`;
  const avatarText = (name)=> (name||'?').trim().slice(0,2);

  function addMessage({name,text,ts,fromId,mine,attachments}){
    const wrap = document.createElement('div');
    const isMe = (typeof mine === 'boolean') ? mine : (fromId === selfId);
    wrap.className = 'msg ' + (isMe ? 'from-me' : 'from-other');

    const av = document.createElement('div'); av.className='avatar'; av.textContent=avatarText(isMe ? myName : (names[fromId]||'ÏÜêÎãò'));
    const col = document.createElement('div');
    if(!isMe){ const nm=document.createElement('div'); nm.className='name'; nm.textContent=names[fromId]||'ÏÜêÎãò'; col.appendChild(nm); }

    const bubble = document.createElement('div'); bubble.className='bubble';
    if(text){ const p=document.createElement('div'); p.appendChild(linkifyToNodes(text)); bubble.appendChild(p); }
    if(attachments?.length){
      for(const att of attachments){
        if(att.type?.startsWith('image/')){
          const img=document.createElement('img'); img.loading='lazy'; img.src=att.url; img.alt=att.name||'image'; bubble.appendChild(img);
        }else{
          const a=document.createElement('a'); a.href=att.url; a.download=att.name||'file'; a.textContent=`${att.name||'ÌååÏùº'} (${toKB(att.size||0)} KB)`; bubble.appendChild(a);
        }
      }
    }
    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('span'); t.className='time'; t.textContent=formatTime(ts||Date.now());
    meta.appendChild(t); bubble.appendChild(meta);

    col.appendChild(bubble);
    if(isMe){ wrap.appendChild(col); } else { wrap.appendChild(av); wrap.appendChild(col); }
    $('#messages').appendChild(wrap);
    $('#messages').lastElementChild?.scrollIntoView({block:'end'});
  }

  /* ===== ÌååÏùº Ï†ÑÏÜ° (Ï¥ù Ï≤≠ÌÅ¨ Ïàò Í∏∞Ï§Ä) ===== */
  const CHUNK_SIZE = 64*1024;           // 64 KB
  const incoming = new Map();           // id ‚Üí { meta, total, received, chunks[] }

  async function prepAttachments(fileList){
    const files = Array.from(fileList||[]), out=[];
    for(const f of files){
      if(f.size > 2*1024*1024){ systemLine(`${f.name} ÏùÄ(Îäî) 2 MB Ï¥àÍ≥ºÎ°ú Ï†ÑÏÜ°ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.`); continue; }   // Îç∞Î™® ÌïúÎèÑ
      const bytes = new Uint8Array(await f.arrayBuffer());
      out.push({ name:f.name, type:f.type, size:f.size, bytes });
    }
    return out;
  }
  async function sendAttachments(fileList){
    if(!room) return;
    const arr = await prepAttachments(fileList);
    for(const a of arr){
      /* Î°úÏª¨ ÎØ∏Î¶¨Î≥¥Í∏∞ */
      const url = URL.createObjectURL(new Blob([a.bytes], {type:a.type||'application/octet-stream'}));
      addMessage({ name: myName, text:'', ts: Date.now(), fromId: selfId,
                   attachments:[{ url, name:a.name, type:a.type, size:a.size }], mine:true });

      /* P2P Ï†ÑÏÜ° */
      const id = `${Date.now()}_${randomId(6)}`;
      const total = Math.ceil(a.bytes.length/CHUNK_SIZE);
      try{
        sendFile({ type:'init', id, meta:{ name:a.name, type:a.type, size:a.size }, total });
        for(let off=0, seq=0; off < a.bytes.length; off+=CHUNK_SIZE, seq++){
          const slice = a.bytes.subarray(off,off+CHUNK_SIZE);
          const b64 = bytesToB64(slice);
          sendFile({ type:'chunk', id, seq, b64 });
        }
        sendFile({ type:'done', id });
      }catch(err){ console.error(err); systemLine(`ÌååÏùº Ï†ÑÏÜ° Ïò§Î•ò: ${a.name}`); }
    }
  }

  /* ===== Ïù¥Î≤§Ìä∏ ===== */
  $('#start').addEventListener('click', async ()=>{
    myName = $('#nick').value.trim() || `ÏÜêÎãò-${randomId(3)}`;
    myRoom = $('#roomId').value.trim() || randomId();
    localStorage.setItem('p2p_nick', myName);
    const url = new URL(location.href); url.searchParams.set('room', myRoom); history.replaceState({}, '', url);
    await startRoom();
  });
  $('#copy').addEventListener('click', async ()=>{
    const url = new URL(location.href);
    if(!myRoom){ myRoom=$('#roomId').value.trim()||randomId(); url.searchParams.set('room', myRoom); history.replaceState({}, '', url); }
    await navigator.clipboard.writeText(url.toString());
    systemLine('Ï¥àÎåÄ ÎßÅÌÅ¨Î•º ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÌñàÏñ¥Ïöî.');
  });
  $('#sendForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const v = $('#input').value.trim();
    if(!room) return;
    if(v){
      const msg = { name: myName, text:v, ts: Date.now(), fromId:selfId };
      addMessage(msg); pushHist({...msg, mine:true});
      try{ sendMsg({ ...msg }); }catch(err){ console.error(err); }
      $('#input').value='';
    }
  });

  /* Ï≤®Î∂Ä Î≤ÑÌäº/ÎìúÎûòÍ∑∏¬∑Î∂ôÏó¨ÎÑ£Í∏∞ */
  const attachBtn = $('#attach');
  const fileInput = $('#file');
  const pad = $('.pad');
  attachBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{ if(e.target.files?.length){ sendAttachments(e.target.files); e.target.value=''; } });
  pad.addEventListener('dragover', (e)=> e.preventDefault());
  pad.addEventListener('drop', (e)=>{ e.preventDefault(); if(e.dataTransfer?.files?.length) sendAttachments(e.dataTransfer.files); });
  $('#input').addEventListener('paste', (e)=>{ const fs=e.clipboardData?.files; if(fs?.length){ e.preventDefault(); sendAttachments(fs); } });

  /* ===== Trystero ÏãúÏûë ===== */
  async function startRoom(){
    if(room) room.leave();

    /* 3) RTDB Ï†ÑÎûµ ÏÑ§Ï†ï */
    const trysteroConfig = { firebaseApp /*, rootPath:'__trystero__', password:'sharedSecret' */ };

    room = joinRoom(trysteroConfig, myRoom, err=>systemLine('Î£∏ Ï†ëÏÜç Ïò§Î•ò: ' + (err?.message||err)));

    /* Ïï°ÏÖò ‚Äì ÌÖçÏä§Ìä∏ */
    [sendMsg, getMsg] = room.makeAction('msg');
    getMsg((data, peerId)=>{
      if(data?.name && peerId) names[peerId]=data.name;
      addMessage(data);
      if(data?.text) pushHist({...data, mine:false});
    });

    /* Ïï°ÏÖò ‚Äì ÎãâÎÑ§ÏûÑ */
    [sendName, getName] = room.makeAction('name');
    sendName(myName);
    room.onPeerJoin(pid=>{
      peers.add(pid); renderPresence();
      sendName(myName, pid);
      systemLine(`${names[pid]||'ÏÉà Ï∞∏Ïó¨Ïûê'} ÏûÖÏû•`);
    });
    room.onPeerLeave(pid=>{
      peers.delete(pid); renderPresence();
      systemLine(`${names[pid]||'Ï∞∏Ïó¨Ïûê'} Ìá¥Ïû•`);
    });
    getName((name, pid)=>{ names[pid]=name; });

    /* Ïï°ÏÖò ‚Äì ÌååÏùº */
    [sendFile, getFile] = room.makeAction('file');
    getFile((payload, pid)=>{
      if(!payload?.type || !payload.id) return;
      const id = payload.id;
      if(payload.type === 'init'){
        incoming.set(id,{ meta:payload.meta||{}, total:payload.total||0, received:0, chunks:[] });
      }else if(payload.type === 'chunk'){
        const rec=incoming.get(id); if(!rec) return;
        rec.chunks[payload.seq]=payload.b64;
        rec.received++;
        if(rec.total && rec.received===rec.total){
          const parts=rec.chunks.map(b64ToBytes);
          let len=0; for(const p of parts) len+=p.length;
          const all=new Uint8Array(len);
          let off=0; for(const p of parts){ all.set(p,off); off+=p.length; }
          const blob=new Blob([all],{type:rec.meta.type||'application/octet-stream'});
          const url=URL.createObjectURL(blob);
          addMessage({ name:names[pid]||'ÏÜêÎãò', text:'', ts:Date.now(), fromId:pid,
                       attachments:[{ url, name:rec.meta.name, type:rec.meta.type, size:rec.meta.size }] });
          incoming.delete(id);
        }
      }else if(payload.type === 'done'){
        const rec=incoming.get(id); if(!rec) return;
        const parts=rec.chunks.map(b64ToBytes);
        let len=0; for(const p of parts) len+=p.length;
        const all=new Uint8Array(len);
        let off=0; for(const p of parts){ all.set(p,off); off+=p.length; }
        const blob=new Blob([all],{type:rec.meta.type||'application/octet-stream'});
        const url=URL.createObjectURL(blob);
        addMessage({ name:names[pid]||'ÏÜêÎãò', text:'', ts:Date.now(), fromId:pid,
                     attachments:[{ url, name:rec.meta.name, type:rec.meta.type, size:rec.meta.size }] });
        incoming.delete(id);
      }
    });

    /* UI */
    $('#setup').style.display='none';
    renderPresence(); renderRoomPill(); renderHist();
    systemLine(`Î£∏ "${myRoom}" Ïóê ÏûÖÏû•ÌñàÏäµÎãàÎã§.`);
  }

  /* URL ÌååÎùºÎØ∏ÌÑ∞Ïóê room Í∞íÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèô ÏûÖÏû• */
  if(myRoom) startRoom();
</script>
</body>
</html>